($=>{function toggleHeaderImageControls(value){var imageControl=wp.customize.control("wc_email_header_image_control"),alignmentControl=wp.customize.control("wc_email_header_image_alignment_control");value&&""!==value?(imageControl&&(imageControl.activate(),imageControl.container.show()),alignmentControl&&(alignmentControl.activate(),alignmentControl.container.show())):(imageControl&&(imageControl.deactivate(),imageControl.container.hide()),alignmentControl&&(alignmentControl.deactivate(),alignmentControl.container.hide()))}function showSuccessMessage(message){wp.customize.notifications&&(wp.customize.notifications.add("success_message",new wp.customize.Notification("success_message",{message:message,type:"success",dismissible:!0})),setTimeout(function(){wp.customize.notifications.remove("success_message")},3e3))}function showErrorMessage(message){wp.customize.notifications&&wp.customize.notifications.add("error_message",new wp.customize.Notification("error_message",{message:message,type:"error",dismissible:!0}))}wp.customize.bind("ready",function(){var iframe_url,get_preview_url=woocommerce_email_customizer_controls_local.previewUrl,email_trigger=woocommerce_email_customizer_controls_local.email_trigger,emailTypeContent=(wp.customize.panel(woocommerce_email_customizer_controls_local.panel_id).expanded.bind(function(isExpanded){var iframe=document.querySelector('iframe[title="Site Preview"]');if(iframe){var baseUrl=iframe.getAttribute("data-src")||iframe.src;if(baseUrl)try{var url=new URL(baseUrl);iframe_url=url.toString(),isExpanded?(wp.customize.previewer.previewUrl.set(get_preview_url),iframe.src=get_preview_url,iframe.setAttribute("data-src",get_preview_url),console.log("Switched to email preview:",get_preview_url)):(wp.customize.previewer.previewUrl.set(iframe_url),iframe.src=iframe_url,iframe.setAttribute("data-src",iframe_url),console.log("Reverted to original preview:",iframe_url))}catch(error){console.error("Error switching preview URL:",error)}else console.warn("Invalid iframe source")}else console.warn("Preview iframe not found")}),wp.customize("woocommerce_email_template",function(value){value.bind(function(newVal){-1!==wp.customize.previewer.previewUrl().indexOf(email_trigger)&&(console.log("Template changed to:",newVal),wp.customize.previewer.refresh())})}),wp.customize("woocommerce_email_template",function(setting){setting.bind(function(value){var template,templateControls;(templateControls={default:{show:["wc_email_rounded_corners_control","wc_email_box_shadow_spread_control"],hide:[]},"template-one":{show:[],hide:["wc_email_rounded_corners_control","wc_email_box_shadow_spread_control"]},"template-two":{show:[],hide:["wc_email_rounded_corners_control","wc_email_box_shadow_spread_control"]},"template-three":{show:[],hide:["wc_email_rounded_corners_control","wc_email_box_shadow_spread_control"]}})[template=value]&&(templateControls[template].show&&templateControls[template].show.forEach(function(controlId){controlId=wp.customize.control(controlId);controlId&&(controlId.activate(),controlId.container.show())}),templateControls[template].hide)&&templateControls[template].hide.forEach(function(controlId){controlId=wp.customize.control(controlId);controlId&&(controlId.deactivate(),controlId.container.hide())}),wp.customize.notifications&&(wp.customize.notifications.add("template_changed",new wp.customize.Notification("template_changed",{message:woocommerce_email_customizer_controls_local.template_changed+" "+value,type:"info",dismissible:!0})),setTimeout(function(){wp.customize.notifications.remove("template_changed")},3e3))})}),woocommerce_email_customizer_controls_local.emailTypeContent||{}),currentEmailType="",isTypeSwitching=!1,initContent=(wp.customize("woocommerce_email_preview_type")&&(currentEmailType=wp.customize("woocommerce_email_preview_type").get()||""),wp.customize("woocommerce_email_preview_type",function(setting){setting.bind(function(newType){isTypeSwitching=!0,currentEmailType&&(emailTypeContent[currentEmailType]={heading:wp.customize("woocommerce_email_heading_text").get()||"",subheading:wp.customize("woocommerce_email_subheading_text").get()||"",body_text:wp.customize("woocommerce_email_body_text").get()||""}),(currentEmailType=newType)&&emailTypeContent[newType]?(newType=emailTypeContent[newType],wp.customize("woocommerce_email_heading_text").set(newType.heading||""),wp.customize("woocommerce_email_subheading_text").set(newType.subheading||""),wp.customize("woocommerce_email_body_text").set(newType.body_text||"")):(wp.customize("woocommerce_email_heading_text").set(""),wp.customize("woocommerce_email_subheading_text").set(""),wp.customize("woocommerce_email_body_text").set("")),wp.customize("woocommerce_email_type_content").set(JSON.stringify(emailTypeContent)),isTypeSwitching=!1})}),currentEmailType&&emailTypeContent[currentEmailType]&&(void 0!==(initContent=emailTypeContent[currentEmailType]).heading&&wp.customize("woocommerce_email_heading_text").set(initContent.heading),void 0!==initContent.subheading&&wp.customize("woocommerce_email_subheading_text").set(initContent.subheading),void 0!==initContent.body_text)&&wp.customize("woocommerce_email_body_text").set(initContent.body_text),["woocommerce_email_heading_text","woocommerce_email_subheading_text","woocommerce_email_body_text"].forEach(function(settingName){wp.customize(settingName,function(setting){setting.bind(function(newVal){isTypeSwitching||currentEmailType&&(emailTypeContent[currentEmailType]||(emailTypeContent[currentEmailType]={}),emailTypeContent[currentEmailType]["woocommerce_email_heading_text"===settingName?"heading":"woocommerce_email_subheading_text"===settingName?"subheading":"body_text"]=newVal,wp.customize("woocommerce_email_type_content").set(JSON.stringify(emailTypeContent)))})})}),wp.customize("woocommerce_email_header_image_placement",function(setting){setting.bind(function(value){toggleHeaderImageControls(value)})}),wp.customize("woocommerce_email_header_image_placement").get());toggleHeaderImageControls(initContent),wp.customize.section("wc_email_header",function(section){section.expanded.bind(function(isExpanded){isExpanded&&toggleHeaderImageControls(wp.customize("woocommerce_email_header_image_placement").get())})}),$(document).on("click","#wb-email-export-btn",function(e){e.preventDefault();var $btn=$(this);$btn.prop("disabled",!0).text(woocommerce_email_customizer_controls_local.loading),$.ajax({url:woocommerce_email_customizer_controls_local.ajaxurl,type:"POST",data:{action:woocommerce_email_customizer_controls_local.export_action,nonce:woocommerce_email_customizer_controls_local.importExportNonce},success:function(response){var json,a;response.success&&response.data?(json=JSON.stringify(response.data,null,2),json=new Blob([json],{type:"application/json"}),json=URL.createObjectURL(json),(a=document.createElement("a")).href=json,a.download="email-customizer-settings-"+(new Date).toISOString().slice(0,10)+".json",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(json),showSuccessMessage(woocommerce_email_customizer_controls_local.export_success)):showErrorMessage(response.data||woocommerce_email_customizer_controls_local.error_occurred)},error:function(){showErrorMessage(woocommerce_email_customizer_controls_local.error_occurred)},complete:function(){$btn.prop("disabled",!1).text($btn.data("original-text")||"Download Settings (JSON)")}})}),$(document).on("click","#wb-email-import-btn",function(e){e.preventDefault();var reader,$btn=$(this),$status=$("#wb-email-import-status"),e=document.getElementById("wb-email-import-file");e&&e.files&&e.files[0]&&(e=e.files[0]).name.endsWith(".json")?((reader=new FileReader).onload=function(event){$btn.prop("disabled",!0).text(woocommerce_email_customizer_controls_local.loading),$status.text("").css("color",""),$.ajax({url:woocommerce_email_customizer_controls_local.ajaxurl,type:"POST",data:{action:woocommerce_email_customizer_controls_local.import_action,nonce:woocommerce_email_customizer_controls_local.importExportNonce,import_data:event.target.result},success:function(response){response.success?($status.text(response.data).css("color","green"),showSuccessMessage(woocommerce_email_customizer_controls_local.import_success),setTimeout(function(){window.location.reload()},1500)):($status.text(response.data).css("color","red"),showErrorMessage(response.data))},error:function(){$status.text(woocommerce_email_customizer_controls_local.error_occurred).css("color","red")},complete:function(){$btn.prop("disabled",!1).text("Import Settings")}})},reader.readAsText(e)):$status.text(woocommerce_email_customizer_controls_local.import_invalid).css("color","red")}),$(document).ajaxError(function(event,xhr,settings,thrownError){settings.url&&-1!==settings.url.indexOf("admin-ajax.php")&&(console.error("AJAX Error in email customizer:",{url:settings.url,error:thrownError,response:xhr.responseText}),wp.customize.notifications)&&wp.customize.notifications.add("ajax_error",new wp.customize.Notification("ajax_error",{message:woocommerce_email_customizer_controls_local.error_occurred,type:"error",dismissible:!0}))})}),window.onerror=function(msg,url,lineNo,columnNo,error){return!(!url||-1===url.indexOf("customizer-control")||(console.error("Email Customizer Error:",{message:msg,source:url,line:lineNo,column:columnNo,error:error}),0))}})(jQuery);